<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="referrer" content="no-referrer">
  <title>Auto Location System</title>
  <style>
    body {
      font-family: 'Segoe UI', sans-serif;
      background: #f5f5f5;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      height: 100vh;
    }
    .card {
      background: #fff;
      padding: 25px;
      border-radius: 16px;
      box-shadow: 0 4px 15px rgba(0,0,0,0.1);
      width: 90%;
      max-width: 450px;
      text-align: center;
    }
    button {
      background: #0078ff;
      color: white;
      border: none;
      padding: 12px 18px;
      border-radius: 8px;
      cursor: pointer;
      margin-top: 10px;
      font-size: 16px;
    }
    button:disabled {
      background: #ccc;
    }
    .spinner {
      display: none;
      margin-top: 10px;
    }
  </style>
</head>
<body>

  <div class="card">
    <h2>Get Your Location</h2>
    <p id="status">Click below to detect your current location.</p>
    <button id="getLocationBtn">Get Location</button>
    <div class="spinner" id="spinner">⏳ Getting location...</div>
    <textarea id="result" rows="3" style="width:100%;margin-top:10px;"></textarea>
  </div>

  <script>
    const btn = document.getElementById('getLocationBtn');
    const statusEl = document.getElementById('status');
    const resultEl = document.getElementById('result');
    const spinner = document.getElementById('spinner');
    const CACHE_KEY = "last_location";
    const CACHE_TIME = 5 * 60 * 1000; // 5 minutes

    btn.addEventListener('click', () => {
      spinner.style.display = 'block';
      statusEl.textContent = "Requesting location...";
      btn.disabled = true;
      getLocation();
    });

    function getLocation() {
      const cache = localStorage.getItem(CACHE_KEY);
      if (cache) {
        const data = JSON.parse(cache);
        if (Date.now() - data.timestamp < CACHE_TIME) {
          showResult(data.text);
          return;
        }
      }

      if (!navigator.geolocation) {
        showError("Geolocation not supported in this browser.");
        return;
      }

      navigator.geolocation.getCurrentPosition(success, () => {
        showError("Please enable location and try again.");
      }, { timeout: 15000 });
    }

    async function success(pos) {
      const lat = pos.coords.latitude.toFixed(6);
      const lon = pos.coords.longitude.toFixed(6);
      if (lat == 0 && lon == 0) return showError("Invalid coordinates.");

      const locationText = await getAddress(lat, lon);
      if (!locationText) return showError("Unable to fetch address.");

      const finalText = `${locationText} | https://www.google.com/maps?q=${lat},${lon}`;
      localStorage.setItem(CACHE_KEY, JSON.stringify({ text: finalText, timestamp: Date.now() }));
      showResult(finalText);
    }

    async function getAddress(lat, lon) {
      try {
        // 1️⃣ BigDataCloud API (Fastest)
        const bdc = await fetch(`https://api.bigdatacloud.net/data/reverse-geocode-client?latitude=${lat}&longitude=${lon}&localityLanguage=en`);
        const bdcData = await bdc.json();
        if (bdcData && bdcData.city) {
          return cleanAddress(`${bdcData.locality || bdcData.city}, ${bdcData.principalSubdivision}, ${bdcData.countryName}`);
        }
      } catch (e) {
        console.warn("BigDataCloud failed, trying Nominatim...");
      }

      try {
        // 2️⃣ Fallback: Nominatim API
        const res = await fetch(`https://nominatim.openstreetmap.org/reverse?format=jsonv2&lat=${lat}&lon=${lon}&accept-language=en`);
        const data = await res.json();
        return cleanAddress(data.display_name || "");
      } catch {
        return "";
      }
    }

    function cleanAddress(str) {
      return str.replace(/،|[^\x00-\x7F]+/g, "").trim();
    }

    function showResult(text) {
      spinner.style.display = 'none';
      statusEl.textContent = "✅ Location detected successfully!";
      resultEl.value = text;
      btn.disabled = false;
    }

    function showError(msg) {
      spinner.style.display = 'none';
      statusEl.textContent = "❌ " + msg;
      btn.disabled = false;
    }
  </script>
</body>
</html>
