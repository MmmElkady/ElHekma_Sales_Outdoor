<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>El Hekma | Sales_Out_Door</title>
<style>
  body{font-family:'Segoe UI',Arial,sans-serif;background:#f6f8fa;margin:0;padding:0;color:#222}
  .container{max-width:520px;margin:40px auto;background:#fff;border-radius:14px;box-shadow:0 4px 24px #0001;padding:30px 22px 18px;text-align:center}
  h3{margin-top:0;font-size:1.25rem;color:#2267b7;font-weight:600}
  #status{margin:14px auto 18px;padding:12px 18px;background:#fff3cd;color:#856404;border-radius:7px;font-size:1rem;min-height:54px;transition:.2s}
  #status.error{background:#fdeaea;color:#c91e2c}
  #status.success{background:#e8f5e9;color:#207d32}
  button{padding:9px 14px;border-radius:8px;border:0;background:#2267b7;color:#fff;font-size:1rem;cursor:pointer;margin:4px}
  button:hover{background:#195497}
  iframe{width:100%;height:600px;border:0;border-radius:8px;background:#f2f3f5;display:none}
  @media(max-width:650px){.container{padding:12px 8px}iframe{height:440px}}
</style>
</head>
<body>
<div class="container">
  <h3>Your location will be auto-filled in the form</h3>
  <div id="status">Checking location permissionsâ€¦</div>
  <div id="controls" style="display:none">
    <button id="requestBtn">Allow Location</button>
    <button id="retryBtn" style="display:none;">Retry</button>
  </div>
  <iframe id="myForm" allow="geolocation" title="Google Form">Loadingâ€¦</iframe>
  <audio id="successSound" preload="auto">
    <source src="https://assets.mixkit.co/active_storage/sfx/2000/2000-preview.mp3" type="audio/mpeg" />
  </audio>
</div>

<script>
const FORM_BASE_URL="https://docs.google.com/forms/d/1PxC3Z-hrlVTmSoQzMZN3ZO1hVyJv6r7K5Le1GyVj1K0/viewform?usp=pp_url";
const entryLocation="entry.123519381";
const CONTACT_EMAIL="mmm842218@gmail.com";
const CACHE_DURATION=5*60*1000; // 5 minutes

const s=document.getElementById("status");
const c=document.getElementById("controls");
const f=document.getElementById("myForm");
const snd=document.getElementById("successSound");
const req=document.getElementById("requestBtn");
const rty=document.getElementById("retryBtn");

const lang=(navigator.language||"en").startsWith("ar")?"ar":"en";
const msgs={
 en:{checking:"Checking location permissionsâ€¦",allow:"ðŸ“ Please enable location and click â€œAllow Locationâ€.",
 getting:"ðŸ“ Getting your locationâ€¦",success:"âœ… Location detected successfully!",
 noGeo:"âŒ Geolocation not supported.",mustHttps:"âš ï¸ Page must use HTTPS."},
 ar:{checking:"Ø¬Ø§Ø±Ù Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ØµÙ„Ø§Ø­ÙŠØ§Øª Ø§Ù„Ù…ÙˆÙ‚Ø¹...",allow:"ðŸ“ ÙŠÙØ±Ø¬Ù‰ ØªÙØ¹ÙŠÙ„ Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ø«Ù… Ø§Ù„Ø¶ØºØ· Ø¹Ù„Ù‰ Â«Ø§Ù„Ø³Ù…Ø§Ø­ Ø¨Ø§Ù„Ù…ÙˆÙ‚Ø¹Â».",
 getting:"ðŸ“ Ø¬Ø§Ø±Ù ØªØ­Ø¯ÙŠØ¯ Ù…ÙˆÙ‚Ø¹Ùƒ...",success:"âœ… ØªÙ… ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ø¨Ù†Ø¬Ø§Ø­!",
 noGeo:"âŒ Ø§Ù„Ù…ÙˆÙ‚Ø¹ ØºÙŠØ± Ù…Ø¯Ø¹ÙˆÙ….",mustHttps:"âš ï¸ ÙŠØ¬Ø¨ ÙØªØ­ Ø§Ù„ØµÙØ­Ø© Ø¹Ø¨Ø± HTTPS."}
};
const t=k=>msgs[lang][k]||msgs.en[k];
const setStatus=(m,cls="")=>{s.innerText=m;s.className=cls;};

function saveCache(lat,lon,addr){
 try{localStorage.setItem("eh_cache",JSON.stringify({lat,lon,addr,ts:Date.now()}))}catch(e){}
}
function loadCache(){
 try{
  const c=JSON.parse(localStorage.getItem("eh_cache"));
  if(c && Date.now()-c.ts<CACHE_DURATION)return c;
 }catch(e){}
 return null;
}

function clean(a){return (a||"").replace(/,+/g,",").replace(/\s*,\s*/g,", ").replace(/^,+|,+$/g,"");}

async function fastAddress(lat,lon){
 const nomUrl=`https://nominatim.openstreetmap.org/reverse?format=jsonv2&lat=${lat}&lon=${lon}&accept-language=${lang}&email=${CONTACT_EMAIL}`;
 const bdcUrl=`https://api.bigdatacloud.net/data/reverse-geocode-client?latitude=${lat}&longitude=${lon}&localityLanguage=${lang}`;
 try{
  const race=await Promise.any([
    fetch(bdcUrl).then(r=>r.json()).then(d=>clean(`${d.locality||d.city||""}, ${d.principalSubdivision||""}, ${d.countryName||""}`)),
    fetch(nomUrl,{headers:{"User-Agent":"ElHekma/fast"}}).then(r=>r.json()).then(d=>clean(d.display_name))
  ]);
  return race;
 }catch(e){return "";}
}

function setForm(lat,lon,addr){
 const maps=`https://www.google.com/maps?q=${lat},${lon}`;
 const val=`${addr||"Unknown"} | ${maps}`;
 f.src=`${FORM_BASE_URL}&${entryLocation}=${encodeURIComponent(val)}&nocache=${Date.now()}`;
 f.style.display="block"; c.style.display="none";
 setStatus(t("success"),"success"); snd.play().catch(()=>{});
 saveCache(lat,lon,addr);
}

async function getLocation(){
 setStatus(t("getting"));
 const cache=loadCache();
 if(cache){setForm(cache.lat,cache.lon,cache.addr);return;}
 if(!navigator.geolocation){setStatus(t("noGeo"),"error");return;}
 const opts={enableHighAccuracy:false,timeout:5000,maximumAge:10000};
 navigator.geolocation.getCurrentPosition(async pos=>{
  const lat=pos.coords.latitude.toFixed(6),lon=pos.coords.longitude.toFixed(6);
  const addr=await fastAddress(lat,lon);
  setForm(lat,lon,addr||`Lat:${lat}, Lon:${lon}`);
 },err=>{
  console.warn("Location error",err);
  setStatus(t("allow"),"error"); c.style.display="block";
 },opts);
}

function init(){
 if(!window.isSecureContext && !location.hostname.includes("localhost")){
  setStatus(t("mustHttps"),"error"); return;
 }
 if(navigator.permissions){
  navigator.permissions.query({name:"geolocation"}).then(p=>{
   if(p.state==="granted")getLocation(); else {setStatus(t("allow"),"error");c.style.display="block";}
   p.onchange=()=>{if(p.state==="granted")getLocation();}
  });
 } else {c.style.display="block";}
}

req.onclick=getLocation;
rty.onclick=getLocation;
document.addEventListener("DOMContentLoaded",()=>setStatus(t("checking"))||init());
</script>
</body>
</html>
