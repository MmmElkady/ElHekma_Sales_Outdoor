<script>
  const FORM_BASE_URL =
    "https://docs.google.com/forms/d/1PxC3Z-hrlVTmSoQzMZN3ZO1hVyJv6r7K5Le1GyVj1K0/viewform?usp=pp_url";
  const entryLocation = "entry.123519381";
  const CONTACT_EMAIL = "mmm842218@gmail.com";
  const CACHE_DURATION = 5 * 60 * 1000; // 5 دقائق

  const statusEl = document.getElementById("status");
  const controlsEl = document.getElementById("controls");
  const requestBtn = document.getElementById("requestBtn");
  const retryBtn = document.getElementById("retryBtn");
  const iframeEl = document.getElementById("myForm");

  // 🌍 تحديد اللغة (عربي أو إنجليزي)
  const lang = (navigator.language || "en").startsWith("ar") ? "ar" : "en";

  // 🗣️ الرسائل بعدة لغات
  const messages = {
    en: {
      checking: "Checking location permissions…",
      allow: "📍 Please enable location and click “Allow Location”.",
      getting: "📍 Getting your location…",
      success: "✅ Location detected successfully!",
      invalid: "⚠️ Invalid location. Please enable GPS.",
      noGeo: "❌ Geolocation not supported in this browser.",
      netError: "⚠️ Internet seems unavailable or too slow. Please check your connection and retry.",
      enableLoc: "Please enable location access.",
      noAddress: "⚠️ Unable to retrieve address. Retry later.",
      mustHttps: "⚠️ Page must be loaded via HTTPS for location to work."
    },
    ar: {
      checking: "جارٍ التحقق من صلاحيات الموقع...",
      allow: "📍 يُرجى تفعيل الموقع ثم الضغط على «السماح بالموقع».",
      getting: "📍 جارٍ تحديد موقعك...",
      success: "✅ تم تحديد الموقع بنجاح!",
      invalid: "⚠️ الموقع غير صالح، يُرجى تفعيل GPS.",
      noGeo: "❌ خاصية الموقع غير مدعومة في هذا المتصفح.",
      netError: "⚠️ يبدو أن الإنترنت غير متاح أو الاتصال ضعيف. يُرجى التحقق من الشبكة ثم إعادة المحاولة.",
      enableLoc: "يُرجى السماح بالوصول إلى الموقع.",
      noAddress: "⚠️ تعذر الحصول على العنوان. حاول لاحقًا.",
      mustHttps: "⚠️ يجب فتح الصفحة عبر HTTPS ليعمل الموقع بشكل صحيح."
    }
  };

  // 🔄 دالة للحصول على الرسالة حسب اللغة
  const t = (key) => messages[lang][key] || messages.en[key];

  function setStatus(msg, cls = "") {
    statusEl.innerText = msg;
    statusEl.className = cls;
  }

  function cleanAddress(place) {
    place = place.replace(/[\u0600-\u06FF]+/g, "").trim();
    place = place.replace(/,+/g, ",").replace(/\s+,/g, ",").replace(/,\s+/g, ", ").trim();
    return place;
  }

  async function getAddress(lat, lon) {
    try {
      const res = await fetch(`https://nominatim.openstreetmap.org/reverse?format=jsonv2&lat=${lat}&lon=${lon}&accept-language=${lang}&email=${encodeURIComponent(CONTACT_EMAIL)}`);
      const data = await res.json();
      if (data?.display_name) return cleanAddress(data.display_name);
    } catch {}
    return "";
  }

  function setForm(lat, lon, place) {
    const mapsLink = `https://www.google.com/maps?q=${lat},${lon}`;
    const value = `${place} | ${mapsLink}`;
    const url = `${FORM_BASE_URL}&${entryLocation}=${encodeURIComponent(value)}&nocache=${Date.now()}`;

    iframeEl.src = url;
    iframeEl.style.display = "block";
    controlsEl.style.display = "none";
    setStatus(t("success"), "success");

    // ⏱️ تحقق من فشل التحميل خلال 10 ثواني
    let loaded = false;
    iframeEl.onload = () => (loaded = true);
    setTimeout(() => {
      if (!loaded) {
        iframeEl.style.display = "none";
        setStatus(t("netError"), "error");
        controlsEl.style.display = "block";
        retryBtn.style.display = "inline-block";
      }
    }, 10000);
  }

  async function getAndSetLocation(force = false) {
    setStatus(t("getting"));
    controlsEl.style.display = "none";

    if (!navigator.geolocation) {
      setStatus(t("noGeo"), "error");
      return;
    }

    navigator.geolocation.getCurrentPosition(
      async (pos) => {
        const lat = pos.coords.latitude.toFixed(6);
        const lon = pos.coords.longitude.toFixed(6);
        const address = await getAddress(lat, lon);
        if (address) setForm(lat, lon, address);
        else setStatus(t("noAddress"), "error");
      },
      (err) => {
        console.warn("❌ Location error:", err);
        setStatus(t("enableLoc"), "error");
        controlsEl.style.display = "block";
      },
      { enableHighAccuracy: true, timeout: 10000, maximumAge: 0 }
    );
  }

  function init() {
    if (!window.isSecureContext && !location.hostname.includes("localhost")) {
      setStatus(t("mustHttps"), "error");
      return;
    }

    if (navigator.permissions && navigator.permissions.query) {
      navigator.permissions.query({ name: "geolocation" }).then((res) => {
        if (res.state === "granted") getAndSetLocation();
        else {
          setStatus(t("allow"), "error");
          controlsEl.style.display = "block";
        }
      });
    } else controlsEl.style.display = "block";
  }

  requestBtn.addEventListener("click", () => getAndSetLocation(true));
  retryBtn.addEventListener("click", () => getAndSetLocation(true));
  document.addEventListener("DOMContentLoaded", () => setStatus(t("checking")) || init());
</script>
