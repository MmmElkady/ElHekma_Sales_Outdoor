<script>
  const FORM_BASE_URL =
    "https://docs.google.com/forms/d/1PxC3Z-hrlVTmSoQzMZN3ZO1hVyJv6r7K5Le1GyVj1K0/viewform?usp=pp_url";
  const entryLocation = "entry.123519381";
  const CONTACT_EMAIL = "mmm842218@gmail.com";
  const CACHE_DURATION = 5 * 60 * 1000; // 5 Ø¯Ù‚Ø§Ø¦Ù‚

  const statusEl = document.getElementById("status");
  const controlsEl = document.getElementById("controls");
  const requestBtn = document.getElementById("requestBtn");
  const retryBtn = document.getElementById("retryBtn");
  const iframeEl = document.getElementById("myForm");

  // ğŸŒ ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù„ØºØ© (Ø¹Ø±Ø¨ÙŠ Ø£Ùˆ Ø¥Ù†Ø¬Ù„ÙŠØ²ÙŠ)
  const lang = (navigator.language || "en").startsWith("ar") ? "ar" : "en";

  // ğŸ—£ï¸ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ Ø¨Ø¹Ø¯Ø© Ù„ØºØ§Øª
  const messages = {
    en: {
      checking: "Checking location permissionsâ€¦",
      allow: "ğŸ“ Please enable location and click â€œAllow Locationâ€.",
      getting: "ğŸ“ Getting your locationâ€¦",
      success: "âœ… Location detected successfully!",
      invalid: "âš ï¸ Invalid location. Please enable GPS.",
      noGeo: "âŒ Geolocation not supported in this browser.",
      netError: "âš ï¸ Internet seems unavailable or too slow. Please check your connection and retry.",
      enableLoc: "Please enable location access.",
      noAddress: "âš ï¸ Unable to retrieve address. Retry later.",
      mustHttps: "âš ï¸ Page must be loaded via HTTPS for location to work."
    },
    ar: {
      checking: "Ø¬Ø§Ø±Ù Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ØµÙ„Ø§Ø­ÙŠØ§Øª Ø§Ù„Ù…ÙˆÙ‚Ø¹...",
      allow: "ğŸ“ ÙŠÙØ±Ø¬Ù‰ ØªÙØ¹ÙŠÙ„ Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ø«Ù… Ø§Ù„Ø¶ØºØ· Ø¹Ù„Ù‰ Â«Ø§Ù„Ø³Ù…Ø§Ø­ Ø¨Ø§Ù„Ù…ÙˆÙ‚Ø¹Â».",
      getting: "ğŸ“ Ø¬Ø§Ø±Ù ØªØ­Ø¯ÙŠØ¯ Ù…ÙˆÙ‚Ø¹Ùƒ...",
      success: "âœ… ØªÙ… ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ø¨Ù†Ø¬Ø§Ø­!",
      invalid: "âš ï¸ Ø§Ù„Ù…ÙˆÙ‚Ø¹ ØºÙŠØ± ØµØ§Ù„Ø­ØŒ ÙŠÙØ±Ø¬Ù‰ ØªÙØ¹ÙŠÙ„ GPS.",
      noGeo: "âŒ Ø®Ø§ØµÙŠØ© Ø§Ù„Ù…ÙˆÙ‚Ø¹ ØºÙŠØ± Ù…Ø¯Ø¹ÙˆÙ…Ø© ÙÙŠ Ù‡Ø°Ø§ Ø§Ù„Ù…ØªØµÙØ­.",
      netError: "âš ï¸ ÙŠØ¨Ø¯Ùˆ Ø£Ù† Ø§Ù„Ø¥Ù†ØªØ±Ù†Øª ØºÙŠØ± Ù…ØªØ§Ø­ Ø£Ùˆ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¶Ø¹ÙŠÙ. ÙŠÙØ±Ø¬Ù‰ Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø´Ø¨ÙƒØ© Ø«Ù… Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø©.",
      enableLoc: "ÙŠÙØ±Ø¬Ù‰ Ø§Ù„Ø³Ù…Ø§Ø­ Ø¨Ø§Ù„ÙˆØµÙˆÙ„ Ø¥Ù„Ù‰ Ø§Ù„Ù…ÙˆÙ‚Ø¹.",
      noAddress: "âš ï¸ ØªØ¹Ø°Ø± Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø§Ù„Ø¹Ù†ÙˆØ§Ù†. Ø­Ø§ÙˆÙ„ Ù„Ø§Ø­Ù‚Ù‹Ø§.",
      mustHttps: "âš ï¸ ÙŠØ¬Ø¨ ÙØªØ­ Ø§Ù„ØµÙØ­Ø© Ø¹Ø¨Ø± HTTPS Ù„ÙŠØ¹Ù…Ù„ Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ø¨Ø´ÙƒÙ„ ØµØ­ÙŠØ­."
    }
  };

  // ğŸ”„ Ø¯Ø§Ù„Ø© Ù„Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø§Ù„Ø±Ø³Ø§Ù„Ø© Ø­Ø³Ø¨ Ø§Ù„Ù„ØºØ©
  const t = (key) => messages[lang][key] || messages.en[key];

  function setStatus(msg, cls = "") {
    statusEl.innerText = msg;
    statusEl.className = cls;
  }

  function cleanAddress(place) {
    place = place.replace(/[\u0600-\u06FF]+/g, "").trim();
    place = place.replace(/,+/g, ",").replace(/\s+,/g, ",").replace(/,\s+/g, ", ").trim();
    return place;
  }

  async function getAddress(lat, lon) {
    try {
      const res = await fetch(`https://nominatim.openstreetmap.org/reverse?format=jsonv2&lat=${lat}&lon=${lon}&accept-language=${lang}&email=${encodeURIComponent(CONTACT_EMAIL)}`);
      const data = await res.json();
      if (data?.display_name) return cleanAddress(data.display_name);
    } catch {}
    return "";
  }

  function setForm(lat, lon, place) {
    const mapsLink = `https://www.google.com/maps?q=${lat},${lon}`;
    const value = `${place} | ${mapsLink}`;
    const url = `${FORM_BASE_URL}&${entryLocation}=${encodeURIComponent(value)}&nocache=${Date.now()}`;

    iframeEl.src = url;
    iframeEl.style.display = "block";
    controlsEl.style.display = "none";
    setStatus(t("success"), "success");

    // â±ï¸ ØªØ­Ù‚Ù‚ Ù…Ù† ÙØ´Ù„ Ø§Ù„ØªØ­Ù…ÙŠÙ„ Ø®Ù„Ø§Ù„ 10 Ø«ÙˆØ§Ù†ÙŠ
    let loaded = false;
    iframeEl.onload = () => (loaded = true);
    setTimeout(() => {
      if (!loaded) {
        iframeEl.style.display = "none";
        setStatus(t("netError"), "error");
        controlsEl.style.display = "block";
        retryBtn.style.display = "inline-block";
      }
    }, 10000);
  }

  async function getAndSetLocation(force = false) {
    setStatus(t("getting"));
    controlsEl.style.display = "none";

    if (!navigator.geolocation) {
      setStatus(t("noGeo"), "error");
      return;
    }

    navigator.geolocation.getCurrentPosition(
      async (pos) => {
        const lat = pos.coords.latitude.toFixed(6);
        const lon = pos.coords.longitude.toFixed(6);
        const address = await getAddress(lat, lon);
        if (address) setForm(lat, lon, address);
        else setStatus(t("noAddress"), "error");
      },
      (err) => {
        console.warn("âŒ Location error:", err);
        setStatus(t("enableLoc"), "error");
        controlsEl.style.display = "block";
      },
      { enableHighAccuracy: true, timeout: 10000, maximumAge: 0 }
    );
  }

  function init() {
    if (!window.isSecureContext && !location.hostname.includes("localhost")) {
      setStatus(t("mustHttps"), "error");
      return;
    }

    if (navigator.permissions && navigator.permissions.query) {
      navigator.permissions.query({ name: "geolocation" }).then((res) => {
        if (res.state === "granted") getAndSetLocation();
        else {
          setStatus(t("allow"), "error");
          controlsEl.style.display = "block";
        }
      });
    } else controlsEl.style.display = "block";
  }

  requestBtn.addEventListener("click", () => getAndSetLocation(true));
  retryBtn.addEventListener("click", () => getAndSetLocation(true));
  document.addEventListener("DOMContentLoaded", () => setStatus(t("checking")) || init());
</script>
